<!--- 7/27/23 RR-->
<!--- this was initially built from Youyou Zhou's animation-scrollama.html template-->
<!--- at https://github.com/zhoyoyo/lede23-animation-->
<!--- see https://github.com/Tonejs/Tone.js/blob/dev/README.md for deets on how I set up tone.js-->

<!doctype html>
<html>
  <head>

    <!-- some basic stuff  -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>The Sounds of Toxins</title>

<!--- *********************************************************************-->
<!---                                                                     --->
<!---                  LOAD STYLESHEETS AND PACKAGES                      --->
<!---                                                                     --->
<!--- *********************************************************************-->
<!--- note the order of my stylesheets matters-->
<link rel="stylesheet" href="base.css">
<link rel="stylesheet" href="custom.css">

<!-- add your d3, Scrollama, and tone.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
<script src="https://unpkg.com/scrollama"></script>
<script src="https://unpkg.com/tone"></script>

<!--- add my javascript-->
<script src="weather_chords.js"></script>

<script>
      // Step 4. load your data with d3.csv()
      //d3.csv("data/happiness-sample-data.csv")
      d3.csv("data/aqi-data-2023-07-24.csv")
      
      // d3.json("happiness-sample-data.json")
        .then(data => {


          const myChart = d3
            .select('#my-svg-chart')
            .append('svg')
            .attr('width', 640)
            .attr('height', 640)

          const days = myChart
            .selectAll('rect')
            .data(data)
            .join('rect');

          const gridSize = 20, gap = 2;

          days
            .attr('x', (d,i) => {
              return Math.floor(i%7)*(gridSize+ gap);
            })
            .attr('y', (d,i) => {
              return Math.floor(i/7)*(gridSize+ gap);
            })
            .attr('width', 0)
            .attr('height', 0)
            .style('fill','lightgrey')
          
          //scrollytelling events based on day
          const showGrid = function() {
            days
              //.transition()
              //.duration(2000)
              .attr('width', gridSize)
              .attr('height', gridSize)
          }

          const showForecast = function() {
            days
              //.transition()
              //.duration(2000)

              // .style('fill', d=> {
              //   if (d.aqi < 300) {return 'green'}
              //   else if (d.aqi > '250') {return 'yellow'}
              //   else if (d.aqi < '151') {return 'orange'}
              //   else if (d.aqi < '201') {return 'red'}
              //   else if (d.aqi < '251') {return 'purple'}
              //   else if (d.aqi < '301') {return 'maroon'}
              //   else {return 'grey'}

              .style('fill', d=> {
                if (d.aqi < 51) {return 'green'}
                else if (d.aqi < 101) {return 'yellow'}
                else if (d.aqi < 151) {return 'orange'}
                else if (d.aqi < 201) {return 'red'}
                else if (d.aqi < 251) {return 'purple'}
                else if (d.aqi < 301) {return 'maroon'}
                else {return 'grey'}
              })
          }

          const playForecast = function() {
            playChord(aqiGood);
            setTimeout(function() {
                playChord(aqiModerate);
            }, 1000);
            setTimeout(function() {
                playChord(aqiUnhealthySensitive);
            }, 2000);
            setTimeout(function() {
                playChord(aqiUnhealthy);
            }, 3000);
            setTimeout(function() {
                playChord(aqiHazardous);
            }, 4000);
            setTimeout(function() {
                playChord(aqiVeryHazardous);
            }, 5000);
          }

          //play a sound
          const audioDay0 = function() {
            playNote();
          }

          const audioDay1 = function() {
            playChord1();
          }

          const audioDay2 = function() {
            playChord2();
          }

          const audioDay3 = function() {
            playChord3();
          }

          const audioDay4 = function() {
            playChord4();
          }

          const audioDay5 = function() {
            playChord5();
          }

          const audioDay6 = function() {
            playChord6();
          }

          // ======================================
          // === HERE starts the scrollama code ===
          // ======================================

          // using d3 for convenience
          const scrolly = d3.select("#scroll-content");
          const figure = scrolly.select("#my-svg-chart");
          const step = scrolly.selectAll(".step"); 

          // initialize the scrollama
          const scroller = scrollama();

          // generic window resize listener event
          function handleResize() {
            
            // 1. update height of step elements
            var stepH = Math.floor(window.innerHeight * 0.75);
            step.style("height", stepH + "px");

            var figureHeight = Math.min(window.innerHeight*0.8,640);
            var figureMarginTop = (window.innerHeight - figureHeight) / 2;

            figure
              .style("height", figureHeight + "px")
              .style("top", figureMarginTop + "px");

            // 3. tell scrollama to update new element dimensions
            scroller.resize();
          }

          // scrollama event handlers
          function handleStepEnter(response) {

            // add color to current step only
            step.classed("is-active", function (d, i) {
              return i === response.index;
            });

            // update sound based on step
            if (response.index == 0) {
              // 1. Make the charts appear
              showGrid();
            } else if (response.index == 1) {
              // 2. change color
              showForecast();
            } else if (response.index == 2) {
              // 3. initialize sound
              initSound();
            } else if (response.index == 3) {
              // play minnetonka data
              playForecast();
            }
          }

          function init() {

            // 1. force a resize on load to ensure proper dimensions are sent to scrollama
            handleResize();

            // 2. setup the scroller passing options
            // 		this will also initialize trigger observations
            // 3. bind scrollama event handlers (this can be chained like below)
            scroller
              .setup({
                step: "#scroll-content .step",
                offset: 0.33,
                debug: true //create a visual line to show where event gets triggered
              })
              .onStepEnter(handleStepEnter);
          }


          // kick things off
          init();
      




  //buttons for interaction
  d3.select('button#btnEnableSound')
            .on('click', initSound)
          d3.select('button#btnShowGrid')
            .on('click', showGrid)
          d3.select('button#btnShowForecast')
            .on('click', showForecast)
          d3.select('button#btnPlayForecast')
            .on('click', playForecast)





  //buttons for testing
  d3.select('button#btn1')
              .on("click", function () {
                playChord(aqiGood);
              })
          d3.select('button#btn2')
              .on("click", function () {
                playChord(aqiHazardous);
              })
          d3.select('button#btn3')
              .on("click", function () {
                playChord(aqiUnhealthySensitive);
              })
          d3.select('button#btn4')
              .on("click", function () {
                playChord(aqiVeryHazardous);
              })
          d3.select('button#btn5')
              .on("click", function () {
                playChord(aqiModerate);
              })
          d3.select('button#btn6')
              .on("click", function () {
                playChord(aqiUnhealthy);
              })
          

          //buttons for legend
          d3.select('button#btnk1')
              .on("click", function () {
                playChord(aqiGood);
              })
          d3.select('button#btnk2')
              .on("click", function () {
                playChord(aqiModerate);
              })
          d3.select('button#btnk3')
              .on("click", function () {
                playChord(aqiUnhealthySensitive);
              })
          d3.select('button#btnk4')
              .on("click", function () {
                playChord(aqiUnhealthy);
              })
          d3.select('button#btnk5')
              .on("click", function () {
                playChord(aqiHazardous);
              })
          d3.select('button#btnk6')
              .on("click", function () {
                playChord(aqiVeryHazardous);
              })


    //end D3      
        })
    </script>

  </head>
  <body>
    <h1>10 Days of Toxic Air</h1>
    <!---<button onclick="playNote()">Click me to play note!</button>--->
    <p><img width="50%" src="images/nyc-haze.jpeg">
    <p>A sonification of air quality in Minnetonka, MN</p>
    <p>update as of 3:58 PM</p>
    <p>
      <h2>play forecast</h2>
      <button id="btnEnableSound">Enable<br>Sound</button>
      <button id="btnShowGrid">Show<br>Grid</button>
      <button id="btnShowForecast">Show<br>Forecast</button>
      <button id="btnPlayForecast">Play<br>Forecast</button>  
      <p>
    <h2>chord perception test (randomly sorted)</h2>
    <button id="btn1" style="width:100px">chord 1</button>
    <button id="btn2" style="width:100px">chord 2</button>
    <button id="btn3" style="width:100px">chord 3</button>
    <button id="btn4" style="width:100px">chord 4</button>
    <button id="btn5" style="width:100px">chord 5</button>
    <button id="btn6" style="width:100px">chord 6</button>

<h2>sound key</h2>
    <button id="btnk1" style="background-color:green; width:100px">Good<br>&nbsp;</button>
    <button id="btnk2" style="background-color:yellow; width:100px">Moderate<br>&nbsp;</button>
    <button id="btnk3" style="background-color:#ffa500; width:100px">Unhealthy for<br>Sensitive</button>
    <button id="btnk4" style="background-color:red; width:100px">Unhealthy<br>&nbsp;</button>
    <button id="btnk5" style="background-color:purple; width:100px">Hazardous<br>&nbsp;</button>
    <button id="btnk6" style="background-color:maroon; width:100px">Very<br>Hazardous</button>

    <h2>scrollama test</h2>
    <p>scroll to activate the forecast</p>
      <div id="scroll-content">
      <div id="my-svg-chart"></div>
      <div id="text">
        <div class="step">Show Blank Grid</div>
        <div class="step">Change Colors Based on AQI Scores</div>
        <div class="step">Enable sound with Tone.start() command</div>
        <div class="step">Play AQI Forecast</div>
      </div>
    </div>


  </body>
</html>